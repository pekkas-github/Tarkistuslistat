<script>

/* STARTER AND GLOBALS */

let arrLists = []

$('document').ready(() => {

  $('#btn-add-list').on('click', addList)
  $('#btn-close').on('click', closePopup)

  google.script.run
    .withSuccessHandler(renderTable)
    .apiCall('getFrontPageLists')
})


function renderTable(lists) {

  arrLists = lists
  let table = `<table>`

  lists.forEach( list => {
    table += `
      <tr>
        <td class="icon open-button">&#x279C;</td>
        <td class="list-header" title="Avaa lista (dblClick)">${list}</td>
        <td class="icon edit-button" title="Muokkaa nimeÃ¤">&#x270D;</td>
        <td class="icon delete-button" title="Poista lista"> &#x2718;</td>
      </tr>`
  })
  
  table += `</table>`

  $('#main-section').html(table)
  $('.edit-button').on('click', editListName)
  $('.delete-button').on('click', removeList)
  $('.open-button').on('click', openList)

  spinner('off')
}


/* EVENT HANDLERS */


function addList() {

  openPopup(
    'Uusi tarkistuslista:',
    '<input class="modal-header" id="txt-list-header">',
    saveList
  )

  $('#txt-list-header').focus()
  $('#txt-list-header').keyup(event => {
    if(event.which === 13){
      saveList()
    }
  })
}


function editListName() {

  const nameElement = $(this).siblings('.list-header')
  const oldName = nameElement.text()

  nameElement.html(`<input type="text" class="input-box" title="Return / Esc"value="${oldName}">`)

  const inputBox = $('.input-box')

  inputBox.focus()
  
  inputBox.keyup(event => {
    if(event.which === 13){
      renameList(nameElement, oldName)
    }

    if(event.which === 27){
      inputBox.remove()
      nameElement.text(oldName)
    }
  })
  
  inputBox.blur(() => {
    inputBox.remove()
    nameElement.text(oldName)
  })

}

function renameList(nameElement, oldName) {

  const newName = $('.input-box').val()

  if(isUniqueName(newName)) {
    spinner('on')
    google.script.run
      .withSuccessHandler(renderTable)
      .apiCall('renameList', oldName, newName)
    return
  }
  
  if(newName === oldName) {
    $('.input-box').remove()
    nameElement.html(oldName)
    return
  }

  alert('Nimi on jo olemassa!')

}


function openList() {

  $(this).css('background-color', 'lightgrey')
  const listName = $(this).siblings('.list-header').text()
  window.open(`${url}?page=listPage&listName=${listName}`, '_top')
}


function removeList() {

  openPopup(
    'Poistetaanko lista:',
    $(this).siblings('.list-header').text(),
    deleteList
  )
}



/* POPUP CALLBACK FUNCTIONS */


function openPopup(headerText, contentHtml, okCallback) {

  $('#lbl-popup-header').text(headerText)
  $('#popup-content').html(contentHtml)
  $('#btn-ok').on('click', okCallback)
  $('#popup').show()
}

function closePopup() {

  $('.modal-content').html('')
  $('#btn-ok').off('click')
  $('#popup').hide()
}


function saveList() {
  
  const listName = $('#txt-list-header').val()

  if (isUniqueName(listName)) {
    spinner('on')
    google.script.run
      .withSuccessHandler(renderTable)
      .apiCall('createList', listName)
    closePopup()
    return
  }

  alert('Nimi on jo olemassa!')
  $('#txt-list-header').focus()
}


function deleteList() {

  const listName = $('#popup-content').text()
  spinner('on')

  google.script.run
    .withSuccessHandler(renderTable)
    .apiCall('deleteList', listName)

  closePopup()
}


/* HELPER FUNCTIONS */


function isUniqueName(newName) {

  const res =  arrLists.every( name => {
    return (name !== newName)
  })

  return res
}


function spinner(status) {

  if (status === 'on') {
    $('#spinner').show()
    return
  }

  if (status === 'off') {
    $('#spinner').hide()
    return
  }

}

</script>